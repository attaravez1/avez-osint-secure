<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avez OSINT-X Web</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #161b22;
            border-radius: 8px;
            padding: 30px;
            border: 1px solid #30363d;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        h1 {
            color: #58a6ff;
            margin-top: 0;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }
        .subtitle {
            color: #8b949e;
            margin-bottom: 25px;
        }
        
        /* NEW: Access Key Section */
        .access-section {
            margin-bottom: 20px;
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .access-section label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: #58a6ff;
            font-weight: bold;
        }
        .access-section label svg {
            color: #a371f7;
        }
        .access-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #accessKeyInput {
            flex-grow: 1;
            padding: 12px 15px;
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        #accessKeyInput:focus {
            outline: none;
            border-color: #a371f7;
        }
        #saveAccessKey {
            padding: 12px 20px;
            background: linear-gradient(135deg, #a371f7, #8957e5);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }
        #saveAccessKey:hover:not(:disabled) {
            background: linear-gradient(135deg, #8957e5, #7c3aed);
        }
        #saveAccessKey:disabled {
            background: #30363d;
            cursor: not-allowed;
        }
        .access-status {
            margin-top: 8px;
            font-size: 13px;
            min-height: 20px;
        }
        .access-status.valid {
            color: #3fb950;
        }
        .access-status.invalid {
            color: #f85149;
        }
        .access-status.neutral {
            color: #8b949e;
        }
        
        .input-section {
            margin-bottom: 30px;
            background: #0d1117;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #58a6ff;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 16px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #1f6feb;
        }
        button {
            padding: 12px 25px;
            background-color: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #2ea043;
        }
        button:disabled {
            background-color: #30363d;
            cursor: not-allowed;
        }
        #clearBtn {
            background-color: #da3633;
        }
        #clearBtn:hover {
            background-color: #f85149;
        }
        .config {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 14px;
        }
        .config input, .config select {
            padding: 8px;
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #c9d1d9;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            font-weight: bold;
        }
        .status.loading {
            display: block;
            background-color: #1c2128;
            border: 1px solid #30363d;
            color: #8b949e;
        }
        .status.error {
            display: block;
            background-color: #3c1e1e;
            border: 1px solid #5c1a1a;
            color: #f85149;
        }
        .results {
            background-color: #0d1117;
            border-radius: 6px;
            border: 1px solid #30363d;
            padding: 20px;
            min-height: 100px;
            max-height: 70vh;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .db-header {
            color: #a371f7;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1em;
            padding-bottom: 5px;
            border-bottom: 1px dashed #30363d;
        }
        .entry {
            background-color: #161b22;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #58a6ff;
            overflow-x: auto;
        }
        .entry pre {
            margin: 0;
            color: #8b949e;
        }
        .no-data {
            color: #8b949e;
            font-style: italic;
            text-align: center;
            padding: 30px;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #484f58;
            border-top: 1px solid #30363d;
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç OSINT-X Web Interface</h1>
        <p class="subtitle">Check the Hidden/breached Info via phone number or email address. Only shows the info which is breached Online. If no result appears, it simply means the data was not found in known breaches, try searching with old num/email. If No logs, then no traces.</p>
        <p class="subtitle"><h3>Note: Enter number with +91 (Sometimes because of api limit you will not get the Result)</h3></p>

        <!-- NEW: Access Key Section -->
        <div class="access-section">
            <label for="accessKeyInput">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Access Key (Required)
            </label>
            <div class="access-input-group">
                <input type="password" 
                       id="accessKeyInput" 
                       placeholder="Enter your access key"
                       autocomplete="off" />
                <button id="saveAccessKey">Save Key</button>
            </div>
            <div id="accessStatus" class="access-status neutral">
                üîë Enter access key to enable search functionality
            </div>
        </div>

        <div class="input-section">
            <label for="queryInput">Target (Phone/Email):</label>
            <div class="input-group">
                <input type="text" id="queryInput" placeholder="e.g., +91 9999999999 or target@example.com" autocomplete="off" />
                <button id="searchBtn">Search</button>
                <button id="clearBtn">Clear</button>

                <!-- Database Link in Footer -->
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #30363d;">
                    <a href="https://drive.usercontent.google.com/u/2/uc?id=1sFHXTMPhnfk6x_qteFX2un-kYRPqUGvU&export=download" 
                       target="_blank" 
                       style="color: #58a6ff; text-decoration: none;">
                        üìä Download Database List
                    </a>
                </div>
            </div>
            <div class="config">
                <div>
                    <label for="limit">Limit:</label>
                    <input type="number" id="limit" value="300" min="1" max="1000" />
                </div>
                <div>
                    <label for="lang">Language:</label>
                    <select id="lang">
                        <option value="en">English (en)</option>
                        <option value="ru">Russian (ru)</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="statusEl" class="status"></div>

        <div class="results" id="resultsEl">
            <div class="no-data">No query executed. Enter a target above.</div>
        </div>

        <div class="footer">
            <div>Results are for educational purposes only.</div>
            <div style="margin-top: 5px; font-size: 10px; color: #30363d;">Secure Backend | No API Key Exposure</div>
        </div>
    </div>

    <script>
        // Configuration
        const DEFAULT_LANG = 'en';
        const DEFAULT_LIMIT = 300;
        const REQUEST_TIMEOUT = 15000; // ms
        
        // Access key storage
        let userAccessKey = localStorage.getItem('osint_access_key') || '';
        let isKeyValid = false;

        // DOM Elements
        const queryInput = document.getElementById('queryInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const limitInput = document.getElementById('limit');
        const langSelect = document.getElementById('lang');
        const statusEl = document.getElementById('statusEl');
        const resultsEl = document.getElementById('resultsEl');
        
        // NEW: Access Key Elements
        const accessKeyInput = document.getElementById('accessKeyInput');
        const saveAccessKeyBtn = document.getElementById('saveAccessKey');
        const accessStatus = document.getElementById('accessStatus');

        // Initialize access key
        function initAccessKey() {
            if (userAccessKey) {
                accessKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                accessStatus.textContent = '‚úÖ Using saved access key';
                accessStatus.className = 'access-status valid';
                isKeyValid = true;
                enableSearch();
            } else {
                accessStatus.textContent = 'üîë Enter access key to enable search functionality';
                accessStatus.className = 'access-status neutral';
                disableSearch();
            }
        }

        // Enable/disable search functionality
        function enableSearch() {
            searchBtn.disabled = false;
            queryInput.disabled = false;
            queryInput.placeholder = "e.g., +91 9999999999 or target@example.com";
        }

        function disableSearch() {
            searchBtn.disabled = true;
            queryInput.disabled = true;
            queryInput.placeholder = "Enter access key first";
        }

        // Save access key
        saveAccessKeyBtn.addEventListener('click', async () => {
            const key = accessKeyInput.value.trim();
            
            if (!key) {
                accessStatus.textContent = '‚ùå Please enter an access key';
                accessStatus.className = 'access-status invalid';
                return;
            }

            saveAccessKeyBtn.disabled = true;
            saveAccessKeyBtn.textContent = 'Verifying...';
            accessStatus.textContent = 'üîê Verifying access key...';
            accessStatus.className = 'access-status neutral';

            // Test the key by making a simple request
            try {
                const testPayload = {
                    accessKey: key,
                    request: 'test',
                    limit: 1,
                    lang: 'en'
                };

                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPayload)
                });

                if (response.status === 401) {
                    throw new Error('Invalid access key');
                }

                // Key is valid
                userAccessKey = key;
                localStorage.setItem('osint_access_key', key);
                isKeyValid = true;
                
                accessKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                accessStatus.textContent = '‚úÖ Access key saved and verified';
                accessStatus.className = 'access-status valid';
                enableSearch();

            } catch (error) {
                if (error.message === 'Invalid access key') {
                    accessStatus.textContent = '‚ùå Invalid access key. Please check and try again.';
                } else {
                    accessStatus.textContent = '‚ùå Connection error. Please try again.';
                }
                accessStatus.className = 'access-status invalid';
                isKeyValid = false;
                disableSearch();
            } finally {
                saveAccessKeyBtn.disabled = false;
                saveAccessKeyBtn.textContent = 'Save Key';
            }
        });

        // Clear saved key (on shift+double click)
        saveAccessKeyBtn.addEventListener('dblclick', (e) => {
            if (e.shiftKey) {
                localStorage.removeItem('osint_access_key');
                userAccessKey = '';
                accessKeyInput.value = '';
                accessStatus.textContent = 'üîë Access key cleared. Enter new key.';
                accessStatus.className = 'access-status neutral';
                disableSearch();
                alert('Access key cleared. Please enter a new key.');
            }
        });

        // Enter key to save
        accessKeyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveAccessKeyBtn.click();
            }
        });

        // Show/hide access key
        accessKeyInput.addEventListener('focus', () => {
            if (accessKeyInput.value === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                accessKeyInput.type = 'text';
                accessKeyInput.value = userAccessKey;
            }
        });

        accessKeyInput.addEventListener('blur', () => {
            if (accessKeyInput.value === userAccessKey && userAccessKey) {
                accessKeyInput.type = 'password';
                accessKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        });

        // Format response as JS-like object
        function formatAsJs(data) {
            if (typeof data !== 'object' || data === null) {
                return JSON.stringify(data, null, 2);
            }
            const lines = [];
            for (const [key, value] of Object.entries(data)) {
                try {
                    const valueStr = JSON.stringify(value, null, 2)
                                        .split('\n')
                                        .map((line, idx) => idx === 0 ? line : '  ' + line)
                                        .join('\n');
                    lines.push(`  ${key}: ${valueStr}`);
                } catch (e) {
                    lines.push(`  ${key}: "<unserializable>"`);
                }
            }
            return '{\n' + lines.join('\n') + '\n}';
        }

        // Pretty print the API response
        function prettyPrintResponse(response) {
            resultsEl.innerHTML = '';

            if (response['Error code']) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'status error';
                errorDiv.textContent = `üö´ API Error: ${response['Error code']}`;
                resultsEl.appendChild(errorDiv);
                return;
            }

            const lst = response['List'];
            if (!lst || Object.keys(lst).length === 0) {
                resultsEl.innerHTML = '<div class="no-data">‚ùå No data found for this target.</div>';
                return;
            }

            for (const [db, dbinfo] of Object.entries(lst)) {
                const dbTitle = (String(db).toLowerCase() === '1win') ? '1win' : db;
                const dbHeader = document.createElement('div');
                dbHeader.className = 'db-header';
                dbHeader.textContent = `üìÅ Database: ${dbTitle}`;
                resultsEl.appendChild(dbHeader);

                const dataList = (typeof dbinfo === 'object' && dbinfo !== null) ? dbinfo['Data'] : null;
                if (!dataList || !Array.isArray(dataList) || dataList.length === 0) {
                    const noEntries = document.createElement('div');
                    noEntries.textContent = '  (no entries)';
                    noEntries.style.color = '#8b949e';
                    noEntries.style.marginLeft = '10px';
                    resultsEl.appendChild(noEntries);
                    continue;
                }

                dataList.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'entry';
                    const pre = document.createElement('pre');
                    const dataToFormat = (typeof entry === 'object' && entry !== null) ? entry : { value: entry };
                    pre.textContent = formatAsJs(dataToFormat);
                    entryDiv.appendChild(pre);
                    resultsEl.appendChild(entryDiv);
                });
            }
        }

        // UPDATED: Query the API with access key
        async function queryApi(query) {
            if (!isKeyValid || !userAccessKey) {
                throw new Error('Access key required. Please enter a valid access key.');
            }

            const limit = parseInt(limitInput.value) || DEFAULT_LIMIT;
            const lang = langSelect.value || DEFAULT_LANG;

            const payload = {
                accessKey: userAccessKey,  // ADDED: Access key sent to backend
                request: query,
                limit: limit,
                lang: lang
            };

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    if (response.status === 401) {
                        // Access key invalid, clear it
                        localStorage.removeItem('osint_access_key');
                        userAccessKey = '';
                        isKeyValid = false;
                        initAccessKey();
                        throw new Error('Access key expired or invalid. Please enter a new key.');
                    }
                    const errorText = await response.text();
                    throw new Error(`Backend error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                if (typeof data !== 'object') {
                    throw new Error('Backend returned non-object response');
                }
                return data;

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`Request timed out after ${REQUEST_TIMEOUT/1000} seconds`);
                }
                throw error;
            }
        }

        // Event Handlers
        searchBtn.addEventListener('click', async () => {
            if (!isKeyValid) {
                accessStatus.textContent = '‚ùå Please enter and save a valid access key first';
                accessStatus.className = 'access-status invalid';
                accessKeyInput.focus();
                return;
            }

            const query = queryInput.value.trim();
            if (!query) {
                alert('Please enter a phone number or email address.');
                return;
            }

            // UI state
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';
            statusEl.className = 'status loading';
            statusEl.textContent = `Querying: ${query} ...`;
            statusEl.style.display = 'block';

            try {
                const response = await queryApi(query);
                statusEl.style.display = 'none';
                prettyPrintResponse(response);
            } catch (error) {
                console.error('Query failed:', error);
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Request failed: ${error.message}`;
                resultsEl.innerHTML = `<div class="status error">${error.message}</div>`;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        });

        clearBtn.addEventListener('click', () => {
            queryInput.value = '';
            resultsEl.innerHTML = '<div class="no-data">No query executed. Enter a target above.</div>';
            statusEl.style.display = 'none';
        });

        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initAccessKey();
            
            const urlParams = new URLSearchParams(window.location.search);
            const presetQuery = urlParams.get('q');
            if (presetQuery) {
                queryInput.value = presetQuery;
            }
        });
    </script>

    <!-- Simple WhatsApp Chat Button -->
    <a href="https://wa.me/27604133434?text=Hello%20I%20have%20a%20question%20about%20OSINT" 
       target="_blank" 
       id="whatsapp-chat-button" 
       title="Chat on WhatsApp">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <path d="M17.507 14.307l-.008.008c-.301.301-.669.449-1.034.449-.366 0-.734-.148-1.035-.449l-1.212-1.211-2.491 1.478 1.478-2.491-1.211-1.211c-.301-.301-.449-.669-.449-1.034 0-.366.148-.734.449-1.035l3.535-3.535c.602-.602 1.654-.602 2.256 0l.708.708c.602.602.602 1.654 0 2.256l-1.649 1.649 1.649 1.649c.602.602.602 1.654 0 2.256l-.708.708z" fill="white"/>
            <path d="M20.52 3.449C18.441 1.371 15.527 0 12.435 0 5.962 0 .687 5.274.687 11.747c0 2.104.601 4.136 1.741 5.917L.037 23.644c-.094.301.037.602.301.769.131.075.301.113.451.113.188 0 .376-.056.526-.169l5.917-4.016c1.634.94 3.478 1.447 5.322 1.447 6.473 0 11.748-5.274 11.748-11.747 0-3.092-1.371-6.006-3.449-8.085zm-8.085 18.77c-1.556 0-3.091-.45-4.441-1.295l-.338-.188-3.516 2.39.94-3.067-.226-.376c-1.069-1.78-1.633-3.854-1.633-5.985 0-5.288 4.299-9.587 9.587-9.587 2.558 0 4.956.996 6.76 2.802 1.806 1.806 2.802 4.202 2.802 6.76 0 5.289-4.299 9.587-9.587 9.587z" fill="white"/>
        </svg>
    </a>

    <style>
    #whatsapp-chat-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: #25D366;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        transition: all 0.3s ease;
        z-index: 999;
        border: 2px solid white;
        text-decoration: none;
    }

    #whatsapp-chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
        background: #1da851;
    }

    #whatsapp-chat-button:active {
        transform: scale(0.95);
    }

    /* Pulse animation */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(37, 211, 102, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
        }
    }

    #whatsapp-chat-button {
        animation: pulse 2s infinite;
    }

    /* Tooltip */
    #whatsapp-chat-button::after {
        content: 'Chat on WhatsApp';
        position: absolute;
        right: 70px;
        top: 50%;
        transform: translateY(-50%);
        background: #161b22;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        border: 1px solid #30363d;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #whatsapp-chat-button:hover::after {
        opacity: 1;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        #whatsapp-chat-button {
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
        }
        
        #whatsapp-chat-button::after {
            display: none;
        }
    }
    </style>
</body>
</html>
